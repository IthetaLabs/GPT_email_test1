<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Copy Window (Rich)</title>
<style>
  :root{--card:#fff;--border:#e5e7eb;--ink:#111827}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fafafa;margin:0;padding:24px;color:var(--ink)}
  .wrap{max-width:820px;margin:0 auto;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}
  h1{margin:0 0 12px 0;font-size:22px}
  .bar{margin:14px 0 16px 0;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{padding:10px 14px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}
  .ok{color:#16a34a}
  .hint{font-size:12px;color:#6b7280;margin:10px 0 0 0}

  /* Outlook-friendly preview */
  #cp-html{
    border:1px solid #d1d5db;border-radius:12px;padding:16px;background:#fff;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 11pt;
    line-height: 1.5;
  }
  #cp-html p{ margin:0 0 10px 0 }
  #cp-html h1,#cp-html h2,#cp-html h3{ margin:16px 0 8px 0 }
  #cp-html ul,#cp-html ol{ margin:0 0 12px 20px }
  #cp-html li{ margin:6px 0 }
</style>
</head>
<body>
<div class="wrap">
  <h1>Copy Window</h1>
  <p>This shows your email exactly as you‚Äôll paste it into Outlook ‚Äî with <b>bold</b>, bullets, emojis, spacing and font intact.</p>

  <div class="bar">
    <button id="copyRich" type="button">Copy (Rich HTML)</button>
    <button id="copyPlain" type="button">Copy (Plain Text)</button>
    <span id="cp-status" aria-live="polite" class="ok"></span>
  </div>

  <div id="cp-html" contenteditable="true">
    <p><em>Waiting for content‚Ä¶</em></p>
  </div>

  <p class="hint">Tip: If a link didn‚Äôt load content, paste your email HTML here and click ‚ÄúCopy (Rich HTML)‚Äù.</p>
</div>

<script>
(function(){
  const box = document.getElementById('cp-html');
  const status = document.getElementById('cp-status');

  function fromQuery(name){ return new URLSearchParams(location.search).get(name); }
  function fromHash(name){
    const h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
    if(!h) return null;
    const parts = h.split('&').reduce((acc, kv) => {
      const i = kv.indexOf('=');
      if (i === -1) return acc;
      acc[kv.slice(0,i)] = kv.slice(i+1);
      return acc;
    }, {});
    return parts[name] || null;
  }
  function safeDecode(s){ try { return decodeURIComponent(s); } catch(e){ return s; } }

  // URL-safe Base64 -> UTF-8 string
  function b64UrlToUtf8(s){
    try{
      s = (s||'').replace(/-/g,'+').replace(/_/g,'/');
      while (s.length % 4) s += '=';
      const bin = atob(s);
      const bytes = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
      return new TextDecoder('utf-8').decode(bytes);
    }catch(e){ return null; }
  }

  function setHTML(html){ box.innerHTML = html; }

  function setTextAsHtml(plain){
    const escaped = plain.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const html = escaped.split(/\n{2,}/).map(p => `<p>${p.replace(/\n/g,'<br>')}</p>`).join('');
    box.innerHTML = html || '<p>(empty)</p>';
  }

  // Load order: #b64h (HTML) -> #html (HTML) -> #text (plain) -> ?text (plain)
  const b64h = fromHash('b64h');
  const hHtml = fromHash('html');
  const hText = fromHash('text');      // support #text=
  const qText = fromQuery('text');

  let loaded = '(none)';

  if (b64h) {
    const raw = b64UrlToUtf8(b64h);
    if (raw != null) { setHTML(raw); loaded = 'b64h'; }
  } else if (hHtml) {
    setHTML(safeDecode(hHtml)); loaded = 'html';
  } else if (hText) {
    const t = safeDecode(hText).replace(/\\n/g,'\n').replace(/\r\n/g,'\n');
    setTextAsHtml(t); loaded = 'text(hash)';
  } else if (qText) {
    const t = safeDecode(qText).replace(/\\n/g,'\n').replace(/\r\n/g,'\n');
    setTextAsHtml(t); loaded = 'text(query)';
  }

  // ---------------- Copy (Rich HTML) ----------------
  document.getElementById('copyRich').addEventListener('click', async () => {
    try {
      const src = document.getElementById('cp-html');
      const clone = src.cloneNode(true); // work on a clone

      // ---- 0) Emoji allow-list: keep ONLY these; drop all others ----
      const ALLOWED = new Set(['üìå','üîî','‚ùó','‚úÖ','‚ùå','üìû','üìß']);

      // Robust emoji matcher: full emoji clusters (pictographs with optional VS16 and ZWJ sequences).
      let EMOJI_RE;
      try {
        EMOJI_RE = new RegExp("(?:\\p{Extended_Pictographic}\\uFE0F?(?:\\u200D\\p{Extended_Pictographic}\\uFE0F?)*)","gu");
      } catch {
        EMOJI_RE = /(?:[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}]\uFE0F?(?:\u200D[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}]\uFE0F?)*)/gu;
      }

      function sanitizeTextKeepOnlyAllowed(s) {
        return s.replace(EMOJI_RE, (cluster) => (ALLOWED.has(cluster) ? cluster : ""));
      }

      // Walk text nodes and sanitize emojis
      (function walk(node){
        const w = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null);
        const nodes = [];
        while (w.nextNode()) nodes.push(w.currentNode);
        nodes.forEach(n => { n.nodeValue = sanitizeTextKeepOnlyAllowed(n.nodeValue); });
      })(clone);
      // ---- /emoji allow-list ----

      // Heading spacing
      clone.querySelectorAll('h1,h2,h3,h4,h5,h6').forEach(h => { h.style.margin = '0 0 8pt 0'; });
      clone.querySelectorAll('h1,h2,h3,h4,h5,h6').forEach(h => {
        const next = h.nextElementSibling;
        if (next && ['P','UL','OL','DIV'].includes(next.tagName)) {
          if (!next.style.marginTop) next.style.marginTop = '6pt';
        }
      });

      // Outlook-safe wrapper
      const wrapped = `<div style="font-family: Arial, Helvetica, sans-serif; font-size: 11pt; line-height: 1.5;">${clone.innerHTML}</div>`;

      if (navigator.clipboard && window.ClipboardItem) {
        await navigator.clipboard.write([
          new ClipboardItem({
            'text/html': new Blob([wrapped], { type: 'text/html' }),
            'text/plain': new Blob([clone.innerText], { type: 'text/plain' }) // use sanitized clone for plain text too
          })
        ]);
      } else {
        const tmp = document.createElement('div');
        tmp.style.position = 'fixed'; tmp.style.left = '-9999px';
        tmp.contentEditable = 'true'; tmp.innerHTML = wrapped;
        document.body.appendChild(tmp);

        const range = document.createRange();
        range.selectNodeContents(tmp);
        const sel = window.getSelection();
        sel.removeAllRanges(); sel.addRange(range);
        document.execCommand('copy'); sel.removeAllRanges();
        document.body.removeChild(tmp);
      }

      status.textContent = 'Copied!';
      setTimeout(()=> status.textContent = '', 1800);
    } catch(e){
      status.textContent = 'Copy failed. Select all and press Ctrl/Cmd + C.';
    }
  });

  // ---------------- Copy (Plain Text) ----------------
  document.getElementById('copyPlain').addEventListener('click', async () => {
    try{
      const txt = box.innerText;
      if (navigator.clipboard?.writeText) { await navigator.clipboard.writeText(txt); }
      else {
        const ta = document.createElement('textarea');
        ta.value = txt; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      }
      status.textContent = 'Copied!';
      setTimeout(()=> status.textContent='', 1800);
    } catch(e){
      status.textContent = 'Copy failed.';
    }
  });

  // (Optional) small debug badge to verify loader
  const loadedBadge = document.createElement('div');
  loadedBadge.style.cssText = 'margin-top:8px;font-size:12px;color:#6b7280';
  loadedBadge.textContent = 'Loaded via: ' + loaded;
  document.querySelector('.wrap').appendChild(loadedBadge);
})();
</script>
</body>
</html>
